// prisma/schema.prisma
// ğŸ¦‹ ButterNovel - Complete Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")  // ç”¨äºè¿ç§»å‘½ä»¤ï¼ˆSession Mode 5432ç«¯å£ï¼‰
}

// ============================================
// ç”¨æˆ·ç³»ç»Ÿ
// ============================================

// ç”¨æˆ·è¡¨ï¼ˆè¯»è€… = ä½œè€…ï¼‰
model User {
  id       String  @id @default(cuid())
  email    String  @unique
  password String?

  // åŸºç¡€ä¿¡æ¯ï¼ˆå¯ä¿®æ”¹ï¼‰
  name   String?
  avatar String?
  avatarPublicId  String? // â­ æ–°å¢å­—æ®µ
  bio    String? @db.Text

  role String @default("USER")

  // OAuth
  googleId   String? @unique
  facebookId String? @unique

  // ä½œå®¶ä¿¡æ¯
  isWriter   Boolean @default(false)
  writerName String?
  writerBio  String? @db.Text

  // è´¦å·çŠ¶æ€
  isVerified Boolean @default(false)
  isActive   Boolean @default(true)
  isBanned   Boolean @default(false)
  isOfficial Boolean @default(false) // å®˜æ–¹è´¦å·æ ‡è¯†

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // å…³ç³»ï¼ˆæš‚æ—¶ç§»é™¤ novelsï¼‰
  // novels          Novel[]  // âŒ æ³¨é‡Šæ‰
  library         Library[]
  readingHistory  ReadingHistory[]
  likes           NovelLike[]
  chapterProgress ChapterProgress[]
  comments        Comment[]
  ratings         Rating[]
  ratingLikes     RatingLike[] // è¯„åˆ†ç‚¹èµ
  ratingReplies   RatingReply[] // è¯„åˆ†å›å¤

  // ç¤¾åŒºåŠŸèƒ½ï¼ˆåæœŸï¼‰
  forumPosts   ForumPost[]
  forumReplies ForumReply[]
  helpedCount  Int         @default(0)

  // ç”¨æˆ·ç­‰çº§å‹‹ç« ç³»ç»Ÿ
  contributionPoints Int @default(0) // è´¡çŒ®åº¦åˆ†æ•°
  level              Int @default(1) // å½“å‰ç­‰çº§ (1-8)
  totalReadingTime   Int @default(0) // æ€»é˜…è¯»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰

  contributionLogs   ContributionLog[]
  readingSessions    ReadingSession[]

  // Privacy settings
  libraryPrivacy Boolean @default(false) // false = public (default), true = private (only visible to self)

  // Follow system
  following Follow[] @relation("UserFollowing")
  followers Follow[] @relation("UserFollowers")

  // Paragraph comments
  paragraphComments     ParagraphComment[]
  paragraphCommentLikes ParagraphCommentLike[]

  // Notification system
  notifications              Notification[]        @relation("NotificationReceiver")
  triggeredNotifications     Notification[]        @relation("NotificationActor")
  notificationPreferences    NotificationPreferences?

  @@index([email])
  @@index([isWriter])
  @@index([level, contributionPoints])
}

// Follow system
model Follow {
  id String @id @default(cuid())

  followerId  String
  follower    User   @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)

  followingId String
  following   User   @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([followerId, followingId]) // One user can only follow another user once
  @@index([followerId])
  @@index([followingId])
}

// ============================================
// å†…å®¹ç³»ç»Ÿ
// ============================================

// åˆ†ç±»ï¼ˆGenreï¼‰
model Category {
  id    Int     @id @default(autoincrement())
  name  String  @unique
  slug  String  @unique
  icon  String?
  order Int     @default(0)

  novels Novel[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

// å°è¯´è¡¨
model Novel {
  id         Int    @id @default(autoincrement())
  title      String
  slug       String @unique
  coverImage String?  // æ™®é€šå°è¯´å¿…éœ€ï¼ŒçŸ­ç¯‡å°è¯´å¯é€‰
  coverImagePublicId  String? // â­ æ–°å¢å­—æ®µ
  blurb      String @db.Text

  // â­ çŸ­ç¯‡å°è¯´æ ‡è¯†
  isShortNovel Boolean @default(false)  // æ˜¯å¦ä¸ºçŸ­ç¯‡å°è¯´
  shortNovelGenre String?  // çŸ­ç¯‡å°è¯´åˆ†ç±» (Age Gap, Billionaire Romance, etc.)
  readingPreview String? @db.Text  // çŸ­ç¯‡å°è¯´é¢„è§ˆå†…å®¹ (å‡ ç™¾å­—ç¬¦)

  // ä½œè€…ï¼ˆæš‚æ—¶ç§»é™¤å¤–é”®ï¼‰
  authorId   String
  // author     User    @relation(fields: [authorId], references: [id])  // âŒ æ³¨é‡Šæ‰
  authorName String  @default("ButterNovel Official")

  // åˆ†ç±»
  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id])

  // çŠ¶æ€
  status      NovelStatus @default(ONGOING)
  isPublished Boolean     @default(false)
  isDraft     Boolean     @default(true)

  // å®¡æ ¸ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰
  isApproved Boolean @default(true)
  reviewNote String? @db.Text
  
  // â­ æ·»åŠ  Ban åŠŸèƒ½å­—æ®µ
  isBanned    Boolean   @default(false)   // æ˜¯å¦è¢«å°ç¦
  bannedUntil DateTime?                    // å°ç¦åˆ°æœŸæ—¶é—´ï¼ˆnull = æ°¸ä¹…å°ç¦ï¼‰
  banReason   String?   @db.Text          // å°ç¦åŸå› 

  // ç»Ÿè®¡
  totalChapters Int @default(0)
  wordCount     Int @default(0)
  viewCount     Int @default(0)
  likeCount     Int @default(0)
  commentCount  Int @default(0)

  // è¯„åˆ†ç»Ÿè®¡
  averageRating Float? // å¹³å‡è¯„åˆ† (2.0-10.0)
  totalRatings  Int    @default(0) // æ€»è¯„åˆ†æ•°

  // æ ‡ç­¾ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰
  tags Tag[] @relation("NovelTags")

  // çƒ­åº¦åˆ†æ•°ï¼ˆç”¨äºHotæ’åºï¼‰
  hotScore Float @default(0)

  // ä¹¦ç­¾è®¡æ•°ï¼ˆç¼“å­˜libraryå…³ç³»çš„è®¡æ•°ï¼‰
  bookmarkCount Int @default(0)

  // â­ å†…å®¹åˆ†çº§å’Œç‰ˆæƒ
  contentRating ContentRating @default(ALL_AGES)
  rightsType    RightsType    @default(ALL_RIGHTS_RESERVED)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // å…³ç³»
  chapters       Chapter[]
  library        Library[]
  readingHistory ReadingHistory[]
  likes          NovelLike[]
  comments       Comment[]
  views          NovelView[]
  ratings        Rating[]
  
  @@index([slug])
  @@index([authorId])
  @@index([categoryId])
  @@index([status])
  @@index([isPublished])
  @@index([isApproved])
  @@index([isPublished, isBanned, likeCount])
  @@index([categoryId, isPublished, isBanned])
  @@index([isShortNovel, isPublished, isBanned])  // çŸ­ç¯‡å°è¯´æŸ¥è¯¢ä¼˜åŒ–
  @@index([isShortNovel, shortNovelGenre])  // çŸ­ç¯‡å°è¯´åˆ†ç±»æŸ¥è¯¢
}

enum NovelStatus {
  ONGOING // è¿è½½ä¸­
  COMPLETED // å·²å®Œç»“
}

// å†…å®¹åˆ†çº§
enum ContentRating {
  ALL_AGES    // æ‰€æœ‰å¹´é¾„
  TEEN_13     // é’å°‘å¹´ 13+
  MATURE_16   // æˆç†Ÿå†…å®¹ 16+
  EXPLICIT_18 // æ˜ç¡®æˆäººå†…å®¹ 18+
}

// ç‰ˆæƒç±»å‹
enum RightsType {
  ALL_RIGHTS_RESERVED // ä¿ç•™æ‰€æœ‰æƒåˆ©
  CREATIVE_COMMONS    // åˆ›ä½œå…±ç”¨è®¸å¯
}

// ç« èŠ‚è¡¨
model Chapter {
  id            Int     @id @default(autoincrement())
  novelId       Int
  novel         Novel   @relation(fields: [novelId], references: [id], onDelete: Cascade)
  chapterNumber Int
  title         String
  slug          String
  content       String  @db.Text
  wordCount     Int     @default(0)
  isPublished   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  readingHistory  ReadingHistory[]
  chapterProgress ChapterProgress[]

  @@unique([novelId, chapterNumber])
  @@index([novelId])
  @@index([novelId, chapterNumber])
  @@index([novelId, isPublished])
  @@index([novelId, isPublished, chapterNumber]) 
}

// ============================================
// é˜…è¯»ç³»ç»Ÿ
// ============================================

// ä¹¦æ¶
model Library {
  id      String @id @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  novelId Int
  novel   Novel  @relation(fields: [novelId], references: [id], onDelete: Cascade)

  addedAt DateTime @default(now())

  @@unique([userId, novelId])
  @@index([userId])
}

// é˜…è¯»å†å²ï¼ˆè®°å½•è¯»åˆ°ç¬¬å‡ ç« ï¼‰
model ReadingHistory {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  novelId   Int
  novel     Novel  @relation(fields: [novelId], references: [id], onDelete: Cascade)
  chapterId Int
  chapter   Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  lastReadAt DateTime @default(now())

  @@unique([userId, novelId])
  @@index([userId])
  @@index([lastReadAt])
}

// ç« èŠ‚é˜…è¯»è¿›åº¦
model ChapterProgress {
  id             String  @id @default(cuid())
  userId         String
  user           User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  chapterId      Int
  chapter        Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  scrollPosition Int     @default(0)
  percentage     Int     @default(0)
  isCompleted    Boolean @default(false)

  updatedAt DateTime @updatedAt

  @@unique([userId, chapterId])
}

// ============================================
// äº’åŠ¨ç³»ç»Ÿ
// ============================================

// ç‚¹èµ
model NovelLike {
  id        String  @id @default(cuid())
  userId    String?
  user      User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  guestId   String?
  ipAddress String?
  novelId   Int
  novel     Novel   @relation(fields: [novelId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, novelId])
  @@unique([guestId, novelId])
  @@index([ipAddress, createdAt])
}

// è¯„è®º
model Comment {
  id      String @id @default(cuid())
  content String @db.Text
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  novelId Int
  novel   Novel  @relation(fields: [novelId], references: [id], onDelete: Cascade)

  // å®¡æ ¸
  isApproved Boolean @default(true)
  isHidden   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([novelId])
  @@index([userId])
  @@index([createdAt])
}

// è¯„åˆ†
model Rating {
  id     String @id @default(cuid())
  score  Int // è¯„åˆ†ï¼š2, 4, 6, 8, 10
  review String? @db.Text // è¯„è®ºå†…å®¹ï¼ˆå¯é€‰ï¼‰
  likeCount Int @default(0) // ç‚¹èµæ•°

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  novelId Int
  novel   Novel @relation(fields: [novelId], references: [id], onDelete: Cascade)

  likes RatingLike[] // ç‚¹èµåˆ—è¡¨
  replies RatingReply[] // å›å¤åˆ—è¡¨

  @@unique([userId, novelId]) // æ¯ä¸ªç”¨æˆ·åªèƒ½è¯„åˆ†ä¸€æ¬¡
  @@index([novelId])
  @@index([createdAt])
  @@index([novelId, likeCount, createdAt]) // ç”¨äºæ’åºï¼šæŒ‰ç‚¹èµæ•°å’Œæ—¶é—´
}

// è¯„åˆ†ç‚¹èµ
model RatingLike {
  id String @id @default(cuid())

  createdAt DateTime @default(now())

  // ç”¨æˆ·ï¼ˆç™»å½•ç”¨æˆ·æˆ–æ¸¸å®¢ï¼‰
  userId   String?
  user     User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  guestId  String? // æ¸¸å®¢æ ‡è¯† (åŸºäºIP+UserAgentçš„hash)

  // å…ƒæ•°æ®
  ipAddress String?
  userAgent String?  @db.Text

  // è¯„åˆ†
  ratingId String
  rating   Rating @relation(fields: [ratingId], references: [id], onDelete: Cascade)

  @@unique([userId, ratingId]) // ç™»å½•ç”¨æˆ·æ¯ä¸ªè¯„åˆ†åªèƒ½ç‚¹èµä¸€æ¬¡
  @@unique([guestId, ratingId]) // æ¸¸å®¢æ¯ä¸ªè¯„åˆ†åªèƒ½ç‚¹èµä¸€æ¬¡
  @@index([ratingId])
}

// è¯„åˆ†å›å¤
model RatingReply {
  id String @id @default(cuid())
  content String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ç”¨æˆ· (å¿…é¡»ç™»å½•æ‰èƒ½å›å¤)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // è¯„åˆ†
  ratingId String
  rating   Rating @relation(fields: [ratingId], references: [id], onDelete: Cascade)

  // åµŒå¥—å›å¤æ”¯æŒ (å¯é€‰ - å¦‚æœè¿™æ˜¯å¯¹å…¶ä»–å›å¤çš„å›å¤)
  parentReplyId String?
  parentReply   RatingReply?  @relation("ReplyToReply", fields: [parentReplyId], references: [id], onDelete: Cascade)
  childReplies  RatingReply[] @relation("ReplyToReply")

  @@index([ratingId, createdAt])
  @@index([parentReplyId])
  @@index([userId])
}

// ============================================
// ç¤¾åŒºç³»ç»Ÿï¼ˆåæœŸï¼‰
// ============================================

// è®ºå›å¸–å­ï¼ˆä¹¦è’æ±‚åŠ©ï¼‰
model ForumPost {
  id      String        @id @default(cuid())
  title   String
  content String        @db.Text
  type    ForumPostType @default(HELP) // HELP=æ±‚ä¹¦, RECOMMEND=æ¨è
  userId  String
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ç»Ÿè®¡
  viewCount   Int     @default(0)
  replyCount  Int     @default(0)
  helpedCount Int     @default(0) // æ‹¯æ•‘äº†å¤šå°‘äºº
  isResolved  Boolean @default(false) // æ˜¯å¦è§£å†³
  isClosed    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  replies ForumReply[]

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

enum ForumPostType {
  HELP // æ±‚ä¹¦
  RECOMMEND // æ¨èä¹¦å•
  DISCUSSION // è®¨è®º
}

// è®ºå›å›å¤
model ForumReply {
  id      String @id @default(cuid())
  content String @db.Text
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId  String
  post    ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  // æ¨èçš„å°è¯´ï¼ˆå¯é€‰ï¼‰
  novelId Int?

  // äº’åŠ¨
  helpfulCount Int @default(0) // æœ‰å¸®åŠ©çš„ç¥¨æ•°

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId])
  @@index([userId])
}

// ============================================
// ç®¡ç†ç³»ç»Ÿ
// ============================================

// ç®¡ç†å‘˜
model Admin {
  id       String    @id @default(cuid())
  email    String    @unique
  password String
  name     String
  role     AdminRole @default(MODERATOR)
  isActive Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

// â­ Admin Profile è¡¨ï¼ˆåœ¨ç°æœ‰è¡¨ä¹‹åæ·»åŠ ï¼‰
model AdminProfile {
  id          Int       @id @default(autoincrement())
  email       String    @unique
  password    String?   // ğŸ”§ SECURITY: å¯†ç hash (bcrypt)
  displayName String    @default("Admin")
  bio         String?   @db.Text
  avatar      String?   @db.Text  // Base64 ç¼–ç çš„åœ†å½¢å¤´åƒ
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([email])
}

// å°è¯´æµè§ˆè®°å½•
model NovelView {
  id        Int      @id @default(autoincrement())
  novelId   Int
  novel     Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  
  // ç”¨æˆ·æ ‡è¯† (äºŒé€‰ä¸€)
  userId    String?
  guestId   String?  // æ¸¸å®¢æ ‡è¯† (åŸºäºIP+UserAgentçš„hash)
  
  // å…ƒæ•°æ®
  ipAddress String?
  userAgent String?  @db.Text
  viewedAt  DateTime @default(now())
  
  @@index([novelId, userId, viewedAt])
  @@index([novelId, guestId, viewedAt])
  @@index([viewedAt])  // ç”¨äºå®šæœŸæ¸…ç†æ—§æ•°æ®
}


enum AdminRole {
  SUPER_ADMIN // è¶…çº§ç®¡ç†å‘˜
  ADMIN // ç®¡ç†å‘˜
  MODERATOR // å†…å®¹å®¡æ ¸å‘˜
}

// ============================================
// ç”¨æˆ·ç­‰çº§å‹‹ç« ç³»ç»Ÿ
// ============================================

// è´¡çŒ®åº¦æ—¥å¿—
model ContributionLog {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  points      Int              // è·å¾—çš„åˆ†æ•°
  type        ContributionType
  description String?

  // å…³è”çš„èµ„æºIDï¼ˆå¯é€‰ï¼‰
  relatedId String? // Rating/Comment/RatingReplyçš„ID

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([type])
}

enum ContributionType {
  RATING        // è¯„åˆ†
  COMMENT       // è¯„è®º
  RATING_REPLY  // è¯„åˆ†å›å¤
  DAILY_READ    // æ¯æ—¥é˜…è¯»
  CHAPTER_READ  // å®Œæˆç« èŠ‚é˜…è¯»
  OTHER
}

// é˜…è¯»ä¼šè¯ï¼ˆç”¨äºç»Ÿè®¡é˜…è¯»æ—¶é•¿ï¼‰
model ReadingSession {
  id        String @id @default(cuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  chapterId Int
  novelId   Int

  startTime DateTime  @default(now())
  endTime   DateTime?
  duration  Int       @default(0) // é˜…è¯»æ—¶é•¿ï¼ˆç§’ï¼‰

  @@index([userId, startTime])
  @@index([novelId])
}

// ============================================
// æ®µè½è¯„è®ºç³»ç»Ÿ
// ============================================

// æ®µè½è¯„è®º
model ParagraphComment {
  id             String  @id @default(cuid())
  novelId        Int
  chapterId      Int
  paragraphIndex Int     // æ®µè½ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰
  content        String  @db.Text
  imageUrl       String? // è¯„è®ºå›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰
  imagePublicId  String? // Cloudinary public_idï¼ˆç”¨äºåˆ é™¤ï¼‰

  // ç”¨æˆ·
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ç»Ÿè®¡
  likeCount Int @default(0) // ç‚¹èµæ•°

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ç‚¹èµåˆ—è¡¨
  likes ParagraphCommentLike[]

  // å›å¤åˆ—è¡¨ï¼ˆè‡ªå¼•ç”¨å…³ç³»ï¼‰
  replies ParagraphComment[] @relation("CommentReplies")

  // å›å¤å…³ç³»ï¼ˆå¦‚æœè¿™æ˜¯ä¸€ä¸ªå›å¤ï¼‰
  parentId String?
  parent   ParagraphComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)

  replyCount Int @default(0) // å›å¤æ•°

  @@index([novelId, chapterId, paragraphIndex])
  @@index([chapterId, paragraphIndex])
  @@index([userId])
  @@index([createdAt])
  @@index([parentId])
}

// æ®µè½è¯„è®ºç‚¹èµ
model ParagraphCommentLike {
  id String @id @default(cuid())

  createdAt DateTime @default(now())

  // ç”¨æˆ·ï¼ˆç™»å½•ç”¨æˆ·æˆ–æ¸¸å®¢ï¼‰
  userId   String?
  user     User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  guestId  String? // æ¸¸å®¢æ ‡è¯† (åŸºäºIP+UserAgentçš„hash)

  // å…ƒæ•°æ®
  ipAddress String?
  userAgent String? @db.Text

  // è¯„è®º
  commentId String
  comment   ParagraphComment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId]) // ç™»å½•ç”¨æˆ·æ¯ä¸ªè¯„è®ºåªèƒ½ç‚¹èµä¸€æ¬¡
  @@unique([guestId, commentId]) // æ¸¸å®¢æ¯ä¸ªè¯„è®ºåªèƒ½ç‚¹èµä¸€æ¬¡
  @@index([commentId])
}

// ============================================
// æ ‡ç­¾ç³»ç»Ÿ
// ============================================

// æ ‡ç­¾è¡¨
model Tag {
  id        String   @id @default(cuid())
  name      String   @unique       // æ ‡ç­¾åç§°ï¼ˆå°å†™ï¼‰
  slug      String   @unique       // URL slug
  count     Int      @default(0)   // ä½¿ç”¨æ¬¡æ•°
  createdAt DateTime @default(now())

  // å…³è”çš„å°è¯´ï¼ˆå¤šå¯¹å¤šï¼‰
  novels Novel[] @relation("NovelTags")

  @@index([slug])
  @@index([count])  // ç”¨äºæŒ‰çƒ­åº¦æ’åº
}

// ============================================
// é€šçŸ¥ç³»ç»Ÿ
// ============================================

// é€šçŸ¥ç±»å‹
enum NotificationType {
  // è¯»è€…ç›¸å…³ï¼ˆç”¨æˆ·èº«ä»½ï¼‰
  RATING_REPLY         // è¯„åˆ†è¢«å›å¤
  RATING_LIKE          // è¯„åˆ†è¢«ç‚¹èµ
  COMMENT_REPLY        // æ®µè½è¯„è®ºè¢«å›å¤
  COMMENT_LIKE         // æ®µè½è¯„è®ºè¢«ç‚¹èµ
  AUTHOR_NEW_NOVEL     // å…³æ³¨çš„ä½œè€…å‘å¸ƒæ–°ä¹¦
  AUTHOR_NEW_CHAPTER   // å…³æ³¨çš„ä½œè€…æ›´æ–°ç« èŠ‚
  NOVEL_UPDATE         // ä¹¦æ¶å°è¯´æ›´æ–°

  // ä½œè€…ç›¸å…³ï¼ˆä½œè€…èº«ä»½ï¼‰
  NOVEL_RATING         // ä½ çš„ä¹¦è¢«è¯„åˆ†
  NOVEL_COMMENT        // ä½ çš„ä¹¦è¢«è¯„è®º
  NEW_FOLLOWER         // æ–°å¢ç²‰ä¸

  // ç³»ç»Ÿé€šçŸ¥
  SYSTEM_ANNOUNCEMENT  // ç³»ç»Ÿå…¬å‘Š
  LEVEL_UP             // ç”¨æˆ·å‡çº§
}

// é€šçŸ¥ä¼˜å…ˆçº§
enum NotificationPriority {
  HIGH    // é«˜ä¼˜å…ˆçº§ï¼ˆå›å¤ã€ç‚¹èµï¼‰
  NORMAL  // æ™®é€šï¼ˆå…³æ³¨æ›´æ–°ï¼‰
  LOW     // ä½ä¼˜å…ˆçº§ï¼ˆç³»ç»Ÿå…¬å‘Šï¼‰
}

// é€šçŸ¥è¡¨
model Notification {
  id        String   @id @default(cuid())

  // æ¥æ”¶è€…
  userId    String
  user      User     @relation("NotificationReceiver", fields: [userId], references: [id], onDelete: Cascade)

  // é€šçŸ¥ç±»å‹å’Œä¼˜å…ˆçº§
  type      NotificationType
  priority  NotificationPriority @default(NORMAL)

  // èšåˆç›¸å…³
  isAggregated    Boolean @default(false)  // æ˜¯å¦ä¸ºèšåˆé€šçŸ¥
  aggregationKey  String?                  // èšåˆé”®ï¼ˆç”¨äºåˆå¹¶åŒç±»é€šçŸ¥ï¼‰
  actorIds        String[]                 // è§¦å‘è€…IDåˆ—è¡¨ï¼ˆèšåˆç”¨ï¼‰
  actorCount      Int @default(1)          // è§¦å‘è€…æ•°é‡

  // å•ä¸ªè§¦å‘è€…ï¼ˆéèšåˆé€šçŸ¥ï¼‰
  actorId         String?
  actor           User?    @relation("NotificationActor", fields: [actorId], references: [id], onDelete: Cascade)

  // å…³è”å®ä½“ï¼ˆæ ¹æ®ç±»å‹ä¸åŒï¼Œå…³è”ä¸åŒçš„å®ä½“ï¼‰
  novelId         Int?
  chapterId       Int?
  ratingId        String?
  commentId       String?

  // é€šçŸ¥å†…å®¹
  title           String            // é€šçŸ¥æ ‡é¢˜
  content         String?  @db.Text // é€šçŸ¥è¯¦ç»†å†…å®¹ï¼ˆå¯é€‰ï¼‰
  imageUrl        String?           // é€šçŸ¥å›¾ç‰‡ï¼ˆå¦‚ä¹¦ç±å°é¢ã€ç”¨æˆ·å¤´åƒï¼‰
  linkUrl         String?           // è·³è½¬é“¾æ¥

  // çŠ¶æ€
  isRead          Boolean @default(false)
  isArchived      Boolean @default(false)
  readAt          DateTime?
  archivedAt      DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId, isRead, createdAt])        // æŸ¥è¯¢æœªè¯»é€šçŸ¥
  @@index([userId, isArchived])               // æŸ¥è¯¢å·²å½’æ¡£é€šçŸ¥
  @@index([aggregationKey])                   // èšåˆæŸ¥è¯¢
  @@index([userId, isArchived, createdAt])    // åˆ†é¡µæŸ¥è¯¢
  @@index([userId, isRead, isArchived])       // æœªè¯»è®¡æ•°æŸ¥è¯¢ä¼˜åŒ–ï¼ˆé«˜é¢‘è½®è¯¢ï¼‰
}

// é€šçŸ¥åå¥½è®¾ç½®
model NotificationPreferences {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // é‚®ä»¶é€šçŸ¥æ€»å¼€å…³
  emailNotifications  Boolean @default(false)

  // åˆ†ç±»å¼€å…³
  enableRatingNotifications   Boolean @default(true)   // è¯„åˆ†ç›¸å…³é€šçŸ¥
  enableCommentNotifications  Boolean @default(true)   // è¯„è®ºç›¸å…³é€šçŸ¥
  enableFollowNotifications   Boolean @default(true)   // å…³æ³¨ç›¸å…³é€šçŸ¥
  enableAuthorNotifications   Boolean @default(true)   // ä½œè€…ç›¸å…³é€šçŸ¥ï¼ˆä¹¦ç±æ›´æ–°ï¼‰

  // é‚®ä»¶é€šçŸ¥åˆ†ç±»å¼€å…³
  emailRatingNotifications    Boolean @default(false)
  emailCommentNotifications   Boolean @default(false)
  emailFollowNotifications    Boolean @default(false)
  emailAuthorNotifications    Boolean @default(false)

  // èšåˆè®¾ç½®
  aggregationEnabled    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
